# Quantaxiså¼€æºé¡¹ç›®

## é¡¹ç›®ç»“æ„

### é¡¶å±‚ç»“æ„é€Ÿè§ˆ

- `QUANTAXIS/`ï¼šPython æ ¸å¿ƒæ¡†æ¶ï¼ˆæ•°æ®ã€æŒ‡æ ‡ã€å› å­ã€ç­–ç•¥ã€è´¦æˆ·ã€å¼•æ“ã€æ¶ˆæ¯ã€Webã€è°ƒåº¦ç­‰ï¼‰
- `qapro-rs/`ï¼šRust é«˜æ€§èƒ½å­ç³»ç»Ÿï¼ˆæ•°æ®/è´¦æˆ·/å›æµ‹/å®æ—¶æ‰§è¡Œ/æ¶ˆæ¯ï¼‰
- `docker/`ï¼šå®¹å™¨ä¸ç¼–æ’
- `config/`ï¼šå®‰è£…/æ›´æ–°è„šæœ¬ä¸æ‰¹å¤„ç†
- `doc/`ã€`STU/`ï¼šæ–‡æ¡£ä¸æ•™ç¨‹
- `examples/`ï¼šç¤ºä¾‹è„šæœ¬
- `README.md`ï¼šæ€»ä½“è¯´æ˜ä¸æ¨¡å—æ¸…å•

### æ ¸å¿ƒæ¨¡å—ä¸èŒè´£

- æ•°æ®ä¾§
  - `QAFetch/`ï¼šç»Ÿä¸€æ•°æ®è·å–é€‚é…ï¼ˆTDX/Tushare/ä¸œæ–¹è´¢å¯Œ/äº¤æ˜“æ‰€API/ClickHouse ç­‰ï¼‰
  - `QASU/`ï¼šæ•°æ®å…¥åº“ä¸æ›´æ–°ï¼ˆMongoDB/ClickHouse åŒæ­¥ã€æ‰¹é‡æ›´æ–°è„šæœ¬ï¼‰
  - `QAData/`ï¼šæ ‡å‡†åŒ–æ•°æ®å®¹å™¨ï¼ˆè‚¡ç¥¨/æŒ‡æ•°/æœŸè´§/åŠ å¯†ï¼Œé‡é‡‡æ ·ã€å¤æƒã€å¸‚å€¼ã€é¢æ¿ç»“æ„ç­‰ï¼‰
- åˆ†æä¾§
  - `QAIndicator/`ï¼šæŠ€æœ¯æŒ‡æ ‡åº“ï¼ˆMA/RSI/MACD ç­‰ï¼Œæ”¯æŒæ‰¹é‡ applyï¼‰
  - `QAFactor/`ï¼šå› å­ç ”ç©¶/å› å­å›æµ‹/å› å­ç®¡ç†ï¼ˆå« `featurebacktest.py`ï¼‰
  - `QAAnalysis/`ï¼šä¿¡å·/æ¿å—åˆ†æå·¥å…·
- äº¤æ˜“ä¾§
  - `QIFI/`ï¼šç»Ÿä¸€è´¦æˆ·ç³»ç»Ÿä¸åè®®ï¼ˆè·¨å¸‚åœºä»“ä½/æƒç›Š/äº¤æ˜“è®°å½•ï¼›SIM/REALï¼›æŒä¹…åŒ–ï¼‰
  - `QAMarket/`ï¼šå¸‚åœºé¢„è®¾/è®¢å•/æŒä»“ï¼ˆä¿è¯é‡‘/æ‰‹ç»­è´¹/æ–¹å‘ä¸å¼€å¹³ï¼‰
  - `QAStrategy/`ï¼šç­–ç•¥æ¡†æ¶ï¼ˆCTA/å¥—åˆ©/å› å­ï¼Œå¤šç­–ç•¥ç®¡ç†ï¼›å›æµ‹/æ¨¡æ‹Ÿ/å®ç›˜ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸï¼‰
- åŸºç¡€è®¾æ–½
  - `QAEngine/`ï¼šä»»åŠ¡å¼•æ“ï¼ˆå¤šçº¿ç¨‹/å¼‚æ­¥/äº‹ä»¶/è°ƒåº¦ï¼‰
  - `QAPubSub/`ï¼šæ¶ˆæ¯å‘å¸ƒè®¢é˜…ï¼ˆåŸºäº MQï¼Œ1-1/1-N/N-N åˆ†å‘ï¼›æ•°æ®/è®¢å•/äº‹ä»¶æ€»çº¿ï¼‰
  - `QAWebServer/`ï¼šTornado Web æœåŠ¡ï¼ˆä¸­å° API/å¾®æœåŠ¡ï¼‰
  - `QASchedule/`ï¼šè°ƒåº¦ä¸­å¿ƒï¼ˆåŸºäº WebServer çš„åå°ä»»åŠ¡/è¿œç¨‹è°ƒåº¦ï¼‰
  - `QAUtil/`ï¼šæ—¶é—´/äº¤æ˜“æ—¥å†/æ•°æ®è½¬æ¢/å‚æ•°/æ—¥å¿—ç­‰é€šç”¨å·¥å…·
  - `QASetting/`ï¼šé…ç½®ä¸æ‰§è¡Œå™¨
  - `QACmd/`ï¼šå‘½ä»¤è¡Œå…¥å£
- Rust å­ç³»ç»Ÿï¼ˆ`qapro-rs/`ï¼‰
  - è¿æ¥å™¨ï¼š`qaconnector/`ï¼ˆMongo/Redis/ClickHouse/RabbitMQ/Parquetï¼‰
  - æ•°æ®/ç»“æ„ï¼š`qadata/`ã€`qadatastruct/`
  - ç­–ç•¥ä¸å›æµ‹ï¼š`qastrategy/`ã€`qafactor/`
  - è´¦æˆ·ä¸åè®®ï¼š`qaprotocol/`ï¼ˆQIFI/MIFIï¼‰ã€`qaportfolio/`
  - è¿è¡Œæ—¶ï¼š`qaruntime/`ï¼ˆå®æ—¶é‡é‡‡æ ·ã€è®¢å•å‘å¸ƒã€QIFI åˆ‡ç‰‡å­˜å‚¨ï¼‰
  - æ—¥å¿—/å®/ç¯å¢ƒï¼š`qalog/`ã€`qamacros/`ã€`qaenv/`

### ç«¯åˆ°ç«¯å…¨é“¾è·¯ï¼ˆä¸¤æ¡å…¸å‹è·¯å¾„ï¼‰

- å›æµ‹é“¾è·¯ï¼ˆå†å²æ•°æ® â†’ ä¿¡å· â†’ äº¤æ˜“ â†’ ç»©æ•ˆï¼‰
  1) æ•°æ®ï¼š`QAFetch` æ‹‰å– â†’ `QASU` å…¥åº“ï¼ˆMongo/ClickHouseï¼‰
  2) åŠ å·¥ï¼š`QAData` è½½å…¥ç»“æ„åŒ–æ•°æ®ï¼ˆé‡é‡‡æ ·/å¤æƒ/é¢æ¿ï¼‰
  3) æŒ‡æ ‡/å› å­ï¼š`QAIndicator`ã€`QAFactor` ç”Ÿæˆç‰¹å¾ä¸ä¿¡å·
  4) ç­–ç•¥ï¼š`QAStrategy` æŒ‰ `on_bar/on_tick` æ¶ˆè´¹æ•°æ®æµ
  5) è´¦æˆ·ï¼š`QIFI` ä»¿çœŸè´¦æˆ·æ’®åˆ/è®¡è´¹/æƒç›Š/æŒä»“
  6) åˆ†æï¼š`QAAnalysis` ä¸é£é™©è¯„ä¼°ï¼Œç»“æœæŒä¹…åŒ–ä¸å¯è§†åŒ–
  7) é«˜æ€§èƒ½é€‰é¡¹ï¼šåŒé“¾è·¯å¯ç”± `qapro-rs` å›æµ‹å™¨æ‰§è¡Œï¼ˆæ›´å¿«çš„è¿­ä»£ä¸I/Oï¼‰
- å®ç›˜/æ¨¡æ‹Ÿé“¾è·¯ï¼ˆè¡Œæƒ… â†’ ç­–ç•¥ â†’ è®¢å• â†’ ç»çºªå•†/ç½‘å…³ â†’ å›å†™è´¦æˆ·ï¼‰
  1) è¡Œæƒ…ï¼šæ•°æ®æº/æ’®åˆç½‘å…³ â†’ `QAPubSub` æ¨æµï¼ˆæˆ– Rust å®æ—¶é‡é‡‡æ ·ï¼‰
  2) ç­–ç•¥ï¼š`QAStrategy` è®¢é˜…è¡Œæƒ…ï¼Œç”Ÿæˆè®¢å•
  3) ä¸‹å•ï¼šé€šè¿‡ `QAPubSub`/OMS â†’ ç»çºªå•†æ¥å£/äº¤æ˜“ç½‘å…³ï¼ˆCTP/QMT/äº¤æ˜“æ‰€APIï¼‰
  4) å›æŠ¥ï¼šæˆäº¤/æŒä»“/èµ„é‡‘å›å†™è‡³ `QIFI`ï¼Œè½åº“ï¼ˆMongo/ClickHouseï¼‰
  5) æœåŠ¡åŒ–ï¼š`QAWebServer` æä¾›æŸ¥è¯¢ä¸æ“ä½œ APIï¼Œ`QASchedule` è´Ÿè´£ä»»åŠ¡ç¼–æ’
  6) è¿è¡Œæ—¶ï¼š`QAEngine` ç®¡ç†å¹¶è¡Œ/å¼‚æ­¥ä»»åŠ¡ï¼Œ`QAUtil/QASetting` æä¾›é€šç”¨æ”¯æ’‘
  7) Rust å®æ—¶ï¼š`qapro-rs` çš„ `Monitor` å°† K çº¿åˆ‡ç‰‡ã€è®¢å•å‘å¸ƒä¸ QIFI åˆ‡ç‰‡æŒä¹…åŒ–

### éƒ¨ç½²ä¸è¿ç»´

- å®¹å™¨ï¼š`docker/qa-service*`ã€`qa-jupyter*`ã€`qa-web-rust2` ç­‰é•œåƒä¸ç¼–æ’
- è„šæœ¬ï¼š`config/*.sh/*.py` ä¸€é”®å®‰è£…ã€æ›´æ–°ä¸æ•°æ®åŒæ­¥
- æ•™ç¨‹ï¼š`STU/` åˆ†é˜¶æ®µè¯´æ˜ï¼›`examples/` ç›´æ¥å¯è¿è¡Œç¤ºä¾‹

### å…³é”®åè®®ä¸æ•°æ®æ ¼å¼

- `QIFI`ï¼šè´¦æˆ·/è®¢å•/æˆäº¤/æŒä»“/æƒç›Šçš„ç»Ÿä¸€ç»“æ„ï¼Œè§£è€¦ç­–ç•¥ä¸è´¦æˆ·å®ç°ï¼›è·¨ Python/Rust/CPP åŒæ„
- å­˜å‚¨ï¼šMongoDBï¼ˆè´¦æˆ·/å†å²åˆ‡ç‰‡/é…ç½®ï¼‰ã€ClickHouseï¼ˆè¡Œæƒ…/ç‰¹å¾/æ˜ç»†é«˜ååï¼‰

### å¸¸ç”¨å…¥å£

- äº¤äº’ï¼š`QUANTAXIS/__main__.py`ï¼ˆCLIï¼‰ã€`QAWebServer`ï¼ˆHTTP APIï¼‰ã€Jupyterï¼ˆ`examples/`ï¼‰
- æ–‡æ¡£ï¼š`doc/*.md`ã€`README.md`ã€`STU/*.md`

æˆ‘å·²å®Œæˆç»“æ„æ¢³ç†ä¸å…¨é“¾è·¯è¯´æ˜ã€‚å¦‚éœ€ï¼Œæˆ‘å¯ä»¥æŒ‰ä½ çš„ä¸šåŠ¡é‡ç‚¹ç”»ä¸€å¼ æ›´å…·ä½“çš„æµç¨‹å›¾æˆ–ç»™å‡ºæœ€å°å¯è·‘ç¤ºä¾‹è„šæœ¬ã€‚

å¥½ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª**å®Œæ•´çš„é‡åŒ–äº¤æ˜“å…¨é“¾è·¯ä¾‹å­**ï¼Œç»“åˆ QUANTAXIS çš„å„ä¸ªæ¨¡å—ï¼ŒæŠŠ**æ¨¡å—è°ƒç”¨å…³ç³»ã€å‡½æ•°ã€æ•°æ®æµã€äº¤æ˜“æµ**éƒ½æ¢³ç†æ¸…æ¥šã€‚è¿™æ ·ä½ å°±èƒ½çœ‹åˆ°â€œä»æŠ“æ•°æ® â†’ å›æµ‹ â†’ å®ç›˜ â†’ é£æ§â€æ•´ä¸ªè¿ä½œæµç¨‹ï¼Œè€Œä¸ä»…ä»…æ˜¯å•ç‹¬çœ‹ä¸€ä¸ªæ¨¡å—ã€‚

---

## QUANTAXIS å…¨é“¾è·¯æ¨¡å—è°ƒç”¨ç¤ºä¾‹

å‡è®¾åœºæ™¯ï¼šä½ æƒ³å†™ä¸€ä¸ªç­–ç•¥ï¼Œ**ä¹°å…¥æœ€è¿‘ä¸€å‘¨æ¶¨å¹…æœ€å¤§çš„è‚¡ç¥¨ï¼ŒæŒæœ‰ 5 å¤©å–å‡º**ï¼Œæ•´ä¸ªæµç¨‹ä»æ•°æ®æŠ“å–åˆ°æ¨¡æ‹Ÿäº¤æ˜“å†åˆ°é£æ§ã€‚

---

## 1ï¸âƒ£ æ•°æ®è·å–ï¼ˆData Fetch + Saveï¼‰

**ç›®æ ‡**ï¼šè·å–è‚¡ç¥¨æ—¥çº¿æ•°æ®ï¼Œå¹¶å­˜åˆ°æ•°æ®åº“

### è°ƒç”¨æµç¨‹

```python
from QUANTAXIS.QASU.save_stock_day import QA_SU_save_stock_day

# å¤–éƒ¨è°ƒç”¨ QASU æ¥å£
QA_SU_save_stock_day('000001')
```

* **å†…éƒ¨è°ƒç”¨**ï¼š
  
  1. `QA_SU_save_stock_day()` â†’ è´Ÿè´£æŠ“æ•°æ®å¹¶å­˜åº“
  2. è°ƒç”¨ `QAFetch.QATdx.QA_fetch_get_stock_day('000001')` â†’ æŠ“å–åŸå§‹æ—¥çº¿
  3. æ•°æ®è½¬æˆç»Ÿä¸€ç»“æ„ `QA_DataStruct_Stock_day`
  4. è°ƒç”¨ `QA_util_sql_mongo_insert()` â†’ å­˜å…¥ MongoDB

ğŸ“Œ æ•°æ®æµï¼š
`QAFetchæŠ“æ•°æ® â†’ QADataStructæ ‡å‡†åŒ– â†’ MongoDBè½åº“`

---

## 2ï¸âƒ£ æ•°æ®æŸ¥è¯¢ï¼ˆQueryï¼‰

**ç›®æ ‡**ï¼šç­–ç•¥ç”¨åˆ°æ•°æ®æ—¶ï¼Œä¼˜å…ˆä»æ•°æ®åº“æŸ¥

```python
from QUANTAXIS.QAQuery.QAQuery import QA_fetch_stock_day_adv

data = QA_fetch_stock_day_adv('000001', '2025-01-01', '2025-03-01')
```

* å†…éƒ¨å…ˆæŸ¥ MongoDB
* å¦‚æœç¼ºå¤±æ•°æ®ï¼Œfallback è°ƒç”¨ QAFetch æŠ“å–
* è¾“å‡º `QA_DataStruct_Stock_day` â†’ å¯ä»¥ç›´æ¥ç»™ç­–ç•¥ç”¨

---

## 3ï¸âƒ£ ç­–ç•¥å¼€å‘ï¼ˆStrategyï¼‰

**ç­–ç•¥é€»è¾‘**ï¼š

```python
from QUANTAXIS.QAStrategy import StrategyTemplate

class MyStrategy(StrategyTemplate):
    def on_bar(self, event):
        df = self.data  # QA_DataStruct
        # é€‰å‡ºæœ€è¿‘ä¸€å‘¨æ¶¨å¹…æœ€å¤§çš„è‚¡ç¥¨
        target = df.select_top_gain(days=5)
        for code in target:
            self.buy(code, 100)  # å‘ä¹°å…¥ä¿¡å·
```

* **è°ƒç”¨æ¨¡å—**ï¼š
  
  * `QAStrategy.on_bar()` â†’ æ¯æ”¶åˆ°æ–° bar æ‰§è¡Œç­–ç•¥é€»è¾‘
  * `QAIndicator` æˆ–è‡ªå®šä¹‰å› å­è®¡ç®—
  * æœ€ç»ˆç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼ˆ`buy()` / `sell()`ï¼‰

---

## 4ï¸âƒ£ å›æµ‹ï¼ˆBacktestï¼‰

```python
from QUANTAXIS.QABacktest import run_backtest

run_backtest(MyStrategy, start='2025-01-01', end='2025-03-01')
```

* **å†…éƒ¨è°ƒç”¨**ï¼š
  
  1. å›æµ‹å¼•æ“è¯»å–å†å²æ•°æ®ï¼ˆQA_fetch / QAQueryï¼‰
  2. è°ƒç”¨ç­–ç•¥ `on_bar()` â†’ ç”Ÿæˆäº¤æ˜“ä¿¡å·
  3. `QAMarket.match()` â†’ æ’®åˆæˆäº¤ï¼Œè€ƒè™‘æ‰‹ç»­è´¹ã€æ»‘ç‚¹
  4. `QAAccount.update()` â†’ æ›´æ–°è´¦æˆ·æŒä»“ã€èµ„é‡‘

ğŸ“Œ æ•°æ®æµ + äº¤æ˜“æµï¼š
`å†å²æ•°æ® â†’ ç­–ç•¥ â†’ äº¤æ˜“ä¿¡å· â†’ æ’®åˆæˆäº¤ â†’ æ›´æ–°è´¦æˆ·`

---

## 5ï¸âƒ£ æ¨¡æ‹Ÿ / å®ç›˜äº¤æ˜“

```python
from QUANTAXIS.QASim import QASim

sim = QASim()
sim.run(strategy=MyStrategy)
```

* **å†…éƒ¨è°ƒç”¨**ï¼š
  
  * ç­–ç•¥ä¿¡å·ç”Ÿæˆ â†’ `QAAccount.update()` æ¨¡æ‹Ÿè´¦æˆ·æ›´æ–°
  * å¦‚æœå®ç›˜ï¼š`QIFI.send_order()` â†’ å‘å•åˆ°åˆ¸å•†

* **client**ï¼š
  
  * æ¨¡æ‹Ÿäº¤æ˜“ï¼šå†…éƒ¨ client å¯¹è±¡æ¨¡æ‹Ÿä¸‹å•
  * å®ç›˜äº¤æ˜“ï¼šQIFIClient æˆ–åˆ¸å•† API å®¢æˆ·ç«¯

---

## 6ï¸âƒ£ é£æ§ï¼ˆRiskï¼‰

* `QAAccount.risk_control()` â†’ æ¯æ¬¡è´¦æˆ·æ›´æ–°æ—¶æ£€æŸ¥èµ„é‡‘å ç”¨ã€æœ€å¤§å›æ’¤
* `QARisk.compute()` â†’ å®šæœŸè®¡ç®—é£é™©æŒ‡æ ‡

---

## ğŸ”— å…¨é“¾è·¯æ€»ç»“ï¼ˆå‡½æ•°çº§ï¼‰

```
# æ•°æ®ç«¯
QA_SU_save_stock_day(code)
    â””â”€ QA_fetch_get_stock_day(code)
        â””â”€ QADataStruct â†’ QA_util_sql_mongo_insert â†’ MongoDB

# æŸ¥è¯¢æ•°æ®
QA_fetch_stock_day_adv(code)
    â””â”€ MongoDB æŸ¥æ•°æ®
    â””â”€ ç¼ºå¤±éƒ¨åˆ† fallback â†’ QA_fetch_get_stock_day

# ç­–ç•¥ç«¯
StrategyTemplate.on_bar()
    â””â”€ é€‰è‚¡ / å› å­è®¡ç®— (QAIndicator / QAFactor)
    â””â”€ buy()/sell() ç”Ÿæˆäº¤æ˜“ä¿¡å·

# å›æµ‹ç«¯
run_backtest(strategy)
    â””â”€ è°ƒç”¨ç­–ç•¥ on_bar()
    â””â”€ QAMarket.match() æ’®åˆæˆäº¤
    â””â”€ QAAccount.update() æ›´æ–°è´¦æˆ·

# æ¨¡æ‹Ÿ/å®ç›˜
QASim.run(strategy)
    â””â”€ QAAccount.update() / QIFI.send_order()
    â””â”€ client æ‰§è¡Œä¸‹å•

# é£æ§
QAAccount.risk_control()
QARisk.compute()
```

---

ğŸ’¡ **ç†è§£è¦ç‚¹**

1. **æ•°æ®çº¿**ï¼šQAFetch â†’ QADataStruct â†’ MongoDB â†’ QAQuery â†’ ç­–ç•¥
2. **äº¤æ˜“çº¿**ï¼šç­–ç•¥ on_bar â†’ äº¤æ˜“ä¿¡å· â†’ æ’®åˆ / æ¨¡æ‹Ÿ / å®ç›˜ â†’ QAAccount â†’ é£æ§
3. **client è§’è‰²**ï¼šè´Ÿè´£â€œè·Ÿå¤–éƒ¨æœåŠ¡äº¤äº’â€ï¼ŒåŒ…æ‹¬æ•°æ®æŠ“å–ã€æ•°æ®åº“ã€å®ç›˜äº¤æ˜“

---

æˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼  **å…¨é“¾è·¯å‡½æ•°è°ƒç”¨å›¾**ï¼ŒæŠŠæ¨¡å—ã€å‡½æ•°ã€æ•°æ®æµå’Œäº¤æ˜“æµéƒ½æ ‡å‡ºæ¥ï¼Œåƒæµæ°´çº¿ä¸€æ ·ç›´è§‚å±•ç¤ºã€‚

ä½ å¸Œæœ›æˆ‘ç”»è¿™ä¸ªå›¾å—ï¼Ÿ

å®Œç¾ï¼Œæˆ‘ä»¬æŠŠæ•´ä¸ª QUANTAXIS å…¨é“¾è·¯ç”¨ä¸€å¼ **å‡½æ•°çº§æµæ°´çº¿å›¾**æ¥è¡¨ç¤ºï¼Œæ ‡æ˜æ¯ä¸ªæ¨¡å—ã€å‡½æ•°ä»¥åŠæ•°æ®/äº¤æ˜“æµçš„å…³ç³»ã€‚

---

## QUANTAXIS å…¨é“¾è·¯å‡½æ•°è°ƒç”¨å›¾ï¼ˆç¤ºæ„ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®æŠ“å–ç«¯             â”‚
â”‚                               â”‚
â”‚  QA_SU_save_stock_day(code)    â”‚
â”‚      â””â”€ QA_fetch_get_stock_day â”‚
â”‚          â””â”€ client (TdxHq/Tushare)æŠ“æ•°æ®
â”‚      â””â”€ QADataStructæ ‡å‡†åŒ–æ•°æ®
â”‚      â””â”€ QA_util_sql_mongo_insert â†’ MongoDB
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ•°æ®æŸ¥è¯¢ç«¯             â”‚
â”‚                               â”‚
â”‚  QA_fetch_stock_day_adv(code) â”‚
â”‚      â””â”€ æŸ¥è¯¢ MongoDB æ•°æ®      â”‚
â”‚      â””â”€ ç¼ºå¤± fallback â†’ QA_fetch_get_stock_day
â”‚      â””â”€ è¿”å› QA_DataStruct    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥å¼€å‘ç«¯             â”‚
â”‚                               â”‚
â”‚ StrategyTemplate.on_bar()      â”‚
â”‚      â””â”€ QAIndicator / QAFactorâ”‚
â”‚      â””â”€ buy()/sell()ç”Ÿæˆäº¤æ˜“ä¿¡å· â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å›æµ‹ç«¯                 â”‚
â”‚                               â”‚
â”‚ run_backtest(strategy)        â”‚
â”‚      â””â”€ è°ƒç”¨ç­–ç•¥ on_bar()     â”‚
â”‚      â””â”€ QAMarket.match()      â”‚
â”‚      â””â”€ QAAccount.update()    â”‚
â”‚      â””â”€ performance()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ¨¡æ‹Ÿ/å®ç›˜äº¤æ˜“ç«¯            â”‚
â”‚                               â”‚
â”‚ QASim.run(strategy)            â”‚
â”‚      â””â”€ QAAccount.update()     â”‚
â”‚      â””â”€ QIFI.send_order()      â”‚
â”‚      â””â”€ client (åˆ¸å•†API)æ‰§è¡Œä¸‹å• â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é£æ§ç«¯                 â”‚
â”‚                               â”‚
â”‚ QAAccount.risk_control()       â”‚
â”‚ QARisk.compute()               â”‚
â”‚      â””â”€ æœ€å¤§å›æ’¤ã€èµ„é‡‘å ç”¨ã€VaR â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ”¹ å›¾è§£è¯´æ˜

1. **æ•°æ®çº¿ï¼ˆå·¦ä¸Š â†’ ä¸­ï¼‰**
   
   * QAFetch æŠ“æ•°æ® â†’ QADataStruct æ ‡å‡†åŒ– â†’ MongoDB â†’ QAQuery æŸ¥è¯¢
   * æ‰€æœ‰ç­–ç•¥/å›æµ‹éƒ½ç”¨è¿™ä¸ªæ ‡å‡†åŒ–æ•°æ®

2. **ç­–ç•¥çº¿ï¼ˆä¸­ â†’ å³ä¸Šï¼‰**
   
   * ç­–ç•¥ `on_bar` / `on_tick` â†’ ç”Ÿæˆäº¤æ˜“ä¿¡å· â†’ å›æµ‹/å®ç›˜å¤„ç†

3. **äº¤æ˜“çº¿ï¼ˆå³ä¸­ â†’ ä¸‹ï¼‰**
   
   * å›æµ‹ï¼š`QAMarket.match()` â†’ `QAAccount.update()`
   * å®ç›˜ï¼š`QIFI.send_order()` â†’ client æ‰§è¡Œè®¢å•

4. **é£æ§çº¿ï¼ˆæœ€ä¸‹ï¼‰**
   
   * QAAccount/ QARisk å®šæœŸæ£€æŸ¥è´¦æˆ·ã€é£æ§æŒ‡æ ‡

5. **client è§’è‰²**
   
   * æ•°æ®æŠ“å–ï¼ˆTdxHq/Tushareï¼‰
   * å®ç›˜äº¤æ˜“ï¼ˆåˆ¸å•† APIï¼‰
   * å°è£…å¤–éƒ¨é€šä¿¡ï¼Œç­–ç•¥æ— éœ€å…³å¿ƒåº•å±‚ç»†èŠ‚

---

ğŸ’¡ è¿™ä¸ªå›¾å±•ç¤ºäº† **ä»æ•°æ®æŠ“å–åˆ°äº¤æ˜“æ‰§è¡Œå†åˆ°é£æ§**çš„å®Œæ•´é“¾è·¯ï¼Œæ¯ä¸ªæ¨¡å—å¯¹åº”çš„å‡½æ•°å’Œä½œç”¨éƒ½æ˜ç¡®ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼  **å¯è§†åŒ–æµç¨‹å›¾**ï¼Œç”¨å½©è‰²ç®­å¤´åŒºåˆ† **æ•°æ®æµ / äº¤æ˜“æµ / é£æ§æµ**ï¼Œæ›´ç›´è§‚å¥½ç†è§£ã€‚

ä½ å¸Œæœ›æˆ‘ç”»è¿™ä¸ªå¯è§†åŒ–ç‰ˆæœ¬å—ï¼Ÿ





æˆ‘å…ˆæ‰“å¼€å¹¶é˜…è¯» `myexamples/test.py` çš„å†…å®¹ï¼Œæ¢³ç†å…¶å¯¼å…¥æ¨¡å—ã€è°ƒç”¨çš„å‡½æ•°ä¸æ‰§è¡Œæµç¨‹ã€‚
Ran tool

æˆ‘å°†æ£€ç´¢ QUANTAXIS ä»£ç åº“ä¸­è¿™å‡ ä¸ªå…³é”®ç¬¦å·çš„å®šä¹‰ä¸å®ç°ä½ç½®ï¼Œä»¥ä¾¿å‡†ç¡®æ¢³ç†è¯¥è„šæœ¬æ¶‰åŠçš„æ¨¡å—ä¸å‡½æ•°è°ƒç”¨æµç¨‹ã€‚éšåæˆ‘ä¼šç»™å‡ºç»“æ„åŒ–ã€é€æ­¥çš„æ‰§è¡Œé“¾è·¯è¯´æ˜ã€‚
Ran tool
Ran tool
Ran tool
Ran tool
Ran tool

æˆ‘å…ˆç²¾ç¡®å®šä½ `QACTABase`ã€`QA_backtest` ç­‰ç¬¦å·çš„å®šä¹‰ä½ç½®å’Œè°ƒç”¨æ ˆï¼Œä»¥ç¡®ä¿æµç¨‹æ¢³ç†å‡†ç¡®æ— è¯¯ã€‚æ¥ç€æˆ‘ä¼šç»™å‡ºç»“æ„åŒ–çš„æ¨¡å—/å‡½æ•°æ¸…å•ä¸æ‰§è¡Œé¡ºåºã€‚
Ran tool
Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

Ran tool

æˆ‘å·²é˜…è¯» `myexamples/test.py` å¹¶æ£€ç´¢å…³è”ç¬¦å·å®šä¹‰ï¼Œç°åœ¨ç»™å‡ºæ¨¡å—/å‡½æ•°æ¸…å•ä¸æ‰§è¡Œé“¾è·¯ï¼ŒæŒ‡å‡ºæ½œåœ¨é—®é¢˜å¹¶ç»™å‡ºæœ€å°ä¿®æ­£å»ºè®®ã€‚

### æ¶‰åŠæ¨¡å—ä¸å…³é”®å‡½æ•°

- æ•°æ®è·å–
  - QUANTAXIS.QAFetch.QAQuery_Advance: `QA_fetch_stock_day_adv(code, start, end)` â†’ è¿”å› `QA_DataStruct_Stock_day`
    
    ```python
    def QA_fetch_stock_day_adv(
    code,
    start='all',
    end=None,
    if_drop_index=True,
    collections=DATABASE.stock_day
    ):
    'è·å–è‚¡ç¥¨æ—¥çº¿'
    ...
    res = QA_fetch_stock_day(code, start, end, format='pd', collections= collections)
    ...
    return QA_DataStruct_Stock_day(res_reset_index)
    ```
- æ•°æ®ç»“æ„
  - QUANTAXIS.QAData.QADataStruct: `QA_DataStruct_Stock_day(init_data_by_df)`
    
    ```python
    class QA_DataStruct_Stock_day(_quotation_base):
    '''
        è‚¡ç¥¨æ—¥çº¿æ•°æ®
    '''
    def __init__(self, init_data_by_df, dtype='stock_day', if_fq='bfq'):
        super().__init__(init_data_by_df, dtype, if_fq)
    ```
- æŠ€æœ¯æŒ‡æ ‡
  - QUANTAXIS.QAIndicator.base: `MA(Series, N)`ï¼ˆç®€å•æ»šåŠ¨å‡çº¿ï¼‰
    
    ```python
    def MA(Series, N):
    return pd.Series.rolling(Series, N).mean()
    ```
- ç­–ç•¥åŸºç±»ä¸å›æµ‹
  - å½“å‰ä»£ç åº“å¯¼å‡ºçš„æ˜¯ `QAStrategyCtaBase`ï¼ˆæœªå‘ç°åä¸º `QACTABase` çš„ç±»åˆ«åï¼‰
    
    ```python
    from QUANTAXIS.QAStrategy.qactabase import QAStrategyCtaBase
    ...
    from QUANTAXIS.QAFactor.featureAnalysis import QAFeatureAnalysis
    ```
  - `QAStrategyCtaBase` æä¾›å›æµ‹å…¥å£ `run_backtest()`ï¼ˆä»¥åŠ on_bar å›è°ƒç­‰ï¼‰
    
    ```python
    def run_backtest(self):
    self.debug()
    self.acc.save()
    risk = QA_Risk(self.acc)
    risk.save()
    ...
    ```

### `test.py` å®é™…è°ƒç”¨é“¾ï¼ˆé€æ­¥ï¼‰

1. `import QUANTAXIS as QA`
   - è§¦å‘å¯¼å…¥ `QAWebServer/QIFI/QAStrategy` ç­‰ï¼›è‹¥æœ¬æœº MongoDB æœªå¯åŠ¨ï¼Œä¼šåœ¨å¯¼å…¥é˜¶æ®µå°è¯•è¿æ¥ `127.0.0.1:27017` å¹¶æŠ¥é”™ï¼ˆä½ å·²é‡åˆ°ï¼‰ã€‚
2. `data = QA.QA_fetch_stock_day_adv('000001', '2020-01-01', '2020-12-31')`
   - èµ° MongoDB `stock_day` é›†åˆè¯»å–ï¼Œè¿”å› `QA_DataStruct_Stock_day`ã€‚
3. `stock_data = QA.QA_DataStruct_Stock_day(data)`
   - å¤šä½™ä¸”ä¸æ­£ç¡®ï¼š`QA_fetch_stock_day_adv` å·²è¿”å›æ•°æ®ç»“æ„ï¼Œä¸æ˜¯ DataFrameï¼›å†æ¬¡æ„é€ ä¼šç±»å‹ä¸åŒ¹é…ã€‚
4. `ma20 = QA.MA(stock_data.close, 20)`
   - ä½¿ç”¨æ»šåŠ¨å‡çº¿å‡½æ•°ï¼Œ`stock_data.close` ä¸ºå•æ ‡çš„æ—¶æ˜¯ Seriesï¼Œè®¡ç®— 20 æ—¥å‡çº¿ã€‚
5. å®šä¹‰ç­–ç•¥ `class MyStrategy(QA.QACTABase): ...`
   - å½“å‰ç‰ˆæœ¬å¹¶æ—  `QA.QACTABase` åˆ«åï¼Œåº”æ”¹ä¸º `QAStrategyCtaBase`ã€‚
   - `on_bar(self, bar)` ä¸­è°ƒç”¨ `self.buy(...)`ï¼›åœ¨ CTA åŸºç±»é‡Œæ›´å¸¸ç”¨çš„æ˜¯ `buy_open/sell_open/...` ç­‰æ–¹æ³•ï¼Œæœªæ£€åˆ° `buy` ç®€å†™ã€‚
6. `result = QA.QA_backtest(MyStrategy, stock_data)`
   - ä»£ç åº“ä¸­æœªæ‰¾åˆ° `QA_backtest` å‡½æ•°ï¼›CTA åŸºç±»æä¾›çš„æ˜¯ `run_backtest()` æµç¨‹ï¼Œæˆ–æ–‡æ¡£é‡Œçš„ `QA_Backtest` ç±»ã€‚

### å…³é”®å¤–éƒ¨ä¾èµ–/ç¯å¢ƒ

- MongoDBï¼šå¯¼å…¥ QUANTAXIS å³ä¼šå¼•ç”¨ QIFI/Mongo ç»„ä»¶ï¼Œéœ€æœ¬åœ° `mongod` å¯ç”¨æˆ–æ”¹ä¸ºä¸è§¦å‘ç›¸å…³æ¨¡å—ã€‚
- æ•°æ®æºï¼š`QA_fetch_stock_day_adv` é»˜è®¤è¯» Mongo ä¸­çš„ `stock_day` é›†åˆã€‚
- æŒ‡æ ‡/åˆ†æï¼š`pyfolio/alphalens/seaborn` ç­‰åœ¨å…¶ä»–ç¤ºä¾‹ä¸­ä¼šæç¤ºå‘Šè­¦ï¼Œä¸æœ¬è„šæœ¬æ— å…³ã€‚

### å­˜åœ¨é—®é¢˜ä¸ä¿®æ­£å»ºè®®

- åç§°ä¸åŒ¹é…ï¼š`QACTABase` â†’ ä½¿ç”¨ `QAStrategyCtaBase`ï¼ˆæˆ–åœ¨ä½ ä»£ç é‡ŒåŠ åˆ«åï¼‰ã€‚
- å›æµ‹å…¥å£ä¸å­˜åœ¨ï¼š`QA_backtest` â†’ ä½¿ç”¨ CTA åŸºç±»è‡ªå¸¦çš„ `run_backtest()` æµç¨‹ã€‚
- é‡å¤åŒ…è£…ï¼šåˆ é™¤ç¬¬äºŒæ¬¡ `QA_DataStruct_Stock_day(...)` æ„é€ ï¼Œç›´æ¥ç”¨ `data`ã€‚
- ä¸‹å•æ–¹æ³•ï¼šå°† `self.buy(...)` æ”¹ä¸º `self.buy_open(...)`ï¼ˆå¹¶ä¼ å…¥ä»·æ ¼/æ—¶é—´ç­‰æ‰€éœ€å‚æ•°ï¼‰ã€‚

### æœ€å°ä¿®æ”¹ç¤ºæ„ï¼ˆä»…ä¾›å‚è€ƒï¼‰

```python
import QUANTAXIS as QA
from QUANTAXIS.QAStrategy.qactabase import QAStrategyCtaBase as QACTABase
from QUANTAXIS.QAIndicator.base import MA

data = QA.QA_fetch_stock_day_adv('000001', '2020-01-01', '2020-12-31')
stock_data = data  # å·²æ˜¯ QA_DataStruct_Stock_day
ma20 = MA(stock_data.close, 20)

class MyStrategy(QACTABase):
    def on_bar(self, bar):
        if bar.close > ma20.iloc[-1]:
            self.buy_open(bar.code, 100, str(bar.date), bar.close)

# éœ€è¦æŒ‰ CTA åŸºç±»è¦æ±‚åˆå§‹åŒ–å¹¶è°ƒç”¨ run_backtest()
# MyStrategy(code='000001', start='2020-01-01', end='2020-12-31').run_backtest()
```

å¦‚éœ€ï¼Œæˆ‘å¯ä»¥æŠŠè„šæœ¬æ”¹æˆå¯è¿è¡Œç‰ˆæœ¬ï¼ˆå« Mongo å¯åŠ¨/è¿æ¥å‚æ•°ä¸å›æµ‹è°ƒç”¨ï¼‰ã€‚
